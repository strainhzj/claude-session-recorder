# Claude Session Recorder - TypeScript 重构版

> 自动捕获并保存 Claude Code CLI 的会话输入输出

## 📋 目录

- [概述](#概述)
- [特性](#特性)
- [技术栈](#技术栈)
- [快速开始](#快速开始)
- [开发指南](#开发指南)
- [构建](#构建)
- [测试](#测试)
- [文档](#文档)
- [迁移说明](#迁移说明)
- [FAQ](#faq)

## 概述

Claude Session Recorder 是一个 Claude Code CLI 插件，自动捕获和保存会话历史。本版本采用 **TypeScript + pkg** 完全重写，无需任何 Shell 脚本，打包成独立可执行文件，实现真正的跨平台兼容。

## 特性

### ✨ 核心功能

- 🔔 **自动记录**：通过 Hook 自动捕获用户输入和工具输出
- 📁 **JSON 格式**：结构化存储，易于处理和分析
- 🔍 **会话管理**：查看、搜索、删除历史会话
- ⚡ **零依赖运行**：打包后的可执行文件无需 Node.js
- 🌍 **跨平台**：支持 Windows、Linux、macOS（Intel + Apple Silicon）

### 🎯 技术亮点

- **100% TypeScript**：完整类型系统，提升代码质量
- **零 Shell 脚本**：统一技术栈，简化维护
- **独立可执行**：pkg 打包，无外部依赖
- **轻量高效**：单文件可执行，快速启动
- **SOLID 原则**：遵循软件工程最佳实践

## 技术栈

```
语言:     TypeScript 5.x
运行时:   Node.js 18+
打包工具: pkg
存储:     JSON 文件
测试:     Vitest
构建:    tsc + pkg
```

## 快速开始

### 安装

```bash
# 克隆仓库
git clone https://github.com/your-repo/claude-session-recorder.git
cd claude-session-recorder

# 安装依赖
npm install

# 构建项目
npm run build

# 打包可执行文件
npm run package

# 安装平台特定的 Hook
npm run install-hooks
```

### 配置

编辑 `config/recorder-config.json`：

```json
{
  "autoStart": true,
  "format": "json",
  "includeToolResults": true,
  "includeTimestamps": true,
  "maxSessionSize": "100MB",
  "retentionDays": 90,
  "sessionsDir": "./sessions"
}
```

### 使用

```bash
# 开始记录
/start-recording

# 停止记录
/stop-recording

# 查看会话
/view-sessions
```

## 开发指南

### 项目结构

```
src/
├── core/              # 核心业务逻辑
│   ├── SessionManager.ts
│   ├── Recorder.ts
│   └── Storage.ts
├── hooks/             # Hook 处理器
│   ├── user-prompt-hook.ts
│   ├── tool-result-hook.ts
│   └── session-end-hook.ts
├── commands/          # 命令实现
│   ├── start.ts
│   ├── stop.ts
│   └── view.ts
├── utils/             # 工具函数
├── types/             # 类型定义
│   ├── session.ts
│   ├── config.ts
│   └── hooks.ts
└── scripts/           # 构建脚本
    ├── install.ts
    └── build.ts
```

### 开发流程

```bash
# 监听模式编译
npm run dev

# 运行测试
npm run test

# 类型检查
tsc --noEmit
```

### 代码规范

遵循以下原则：

1. **SOLID**：单一职责、开闭原则、里氏替换、接口隔离、依赖倒置
2. **KISS**：保持简单，避免过度设计
3. **DRY**：不要重复代码
4. **YAGNI**：只实现需要的功能

## 构建

### 构建所有平台

```bash
npm run package:all
```

### 构建特定平台

```bash
# Windows
pkg src/hooks/user-prompt-hook.ts --target node18-win-x64 --output hooks-bin/user-prompt-hook.exe

# Linux
pkg src/hooks/user-prompt-hook.ts --target node18-linux-x64 --output hooks-bin/user-prompt-hook

# macOS (Intel)
pkg src/hooks/user-prompt-hook.ts --target node18-macos-x64 --output hooks-bin/user-prompt-hook

# macOS (Apple Silicon)
pkg src/hooks/user-prompt-hook.ts --target node18-macos-arm64 --output hooks-bin/user-prompt-hook
```

### 安装 Hook

```bash
npm run install-hooks
```

## 测试

### 单元测试

```bash
npm run test
```

### 集成测试

```bash
# 测试 Hook 执行
echo '{"user_prompt":"测试"}' | ./hooks-bin/user-prompt-hook.exe

# 验证会话文件
cat sessions/conversation-*.json
```

## 文档

详细文档请查看：

- [技术栈选型报告](./01-技术栈选型报告.md)
- [实施方案](./02-实施方案.md)
- [Hook 配置与安装](./03-Hook配置与安装.md)

## 迁移说明

### 从 Shell 版本迁移

如果你正在使用原 Shell 版本：

1. **数据兼容**：JSON 格式完全兼容，无需迁移
2. **配置兼容**：配置文件格式保持一致
3. **功能对等**：所有核心功能均已实现

### 迁移步骤

```bash
# 1. 备份现有会话
cp -r sessions sessions.backup

# 2. 安装新版本
npm install
npm run build
npm run package
npm run install-hooks

# 3. 验证功能
/start-recording
# 进行一些操作...
/stop-recording
/view-sessions
```

## FAQ

### Q: 为什么选择 TypeScript 而不是保持 Shell 脚本？

A: TypeScript 提供以下优势：
- **类型安全**：编译时捕获错误
- **可维护性**：更好的代码组织
- **可扩展性**：更容易添加新功能
- **跨平台**：统一的构建流程

### Q: pkg 打包的文件有多大？

A: 约 40-60MB（包含 Node.js 运行时）。不同平台略有差异。

### Q: 是否需要安装 Node.js 才能使用？

A: 不需要。pkg 打包的可执行文件包含完整的运行时，可直接执行。

### Q: 如何调试 Hook？

A: 查看 `logs/` 目录中的日志文件，或在 Hook 中添加 `console.error` 输出。

### Q: 支持哪些平台？

A:
- Windows 10/11 (x64)
- Linux (x64)
- macOS 11+ (Intel x64)
- macOS 11+ (Apple Silicon ARM64)

### Q: 会话文件存储在哪里？

A: 默认在 `./sessions/` 目录，可在 `config/recorder-config.json` 中配置。

### Q: 如何清理旧会话？

A: 删除 `sessions/` 目录中对应的 JSON 文件，或使用 `/view-sessions` 命令选择删除。

### Q: Hook 超时怎么办？

A: 在 `hooks/hooks.json` 中增加 `timeout` 值（默认 10-15 秒）。

## 贡献

欢迎贡献！请遵循以下步骤：

1. Fork 仓库
2. 创建特性分支
3. 提交变更
4. 推送到分支
5. 创建 Pull Request

## 许可证

MIT License - 详见 LICENSE 文件

## 作者

strainhzj

## 致谢

感谢 Claude Code CLI 团队提供的插件系统和 Hook 机制。

---

**项目状态**：🚧 开发中

**版本**：2.0.0-alpha

**更新日期**：2025-12-23
